var AJAX_SETUP=APP_HTML+"/ajax/setup.php?"+VALUES,hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d&&(hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""));break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}VK.callMethod("setLocation",hashLoc)}},clientAdd=function(a){function b(){var b={op:"client_add",org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),
telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};b.org||b.fio?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Новый клиент внесён"),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Обязательно укажите название организации или контактное лицо</SPAN>',top:-47,left:98,indent:80,show:1,remove:1}),$("#ca-org").focus())}var c=_dialog({width:450,head:"Добавление нoвого клиента",
content:'<table class="client-add"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100"><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="ca-fio" maxlength="100"><tr><td class="label">Телефоны:<td><input type="text" id="ca-telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100"></table>',submit:b});$("#ca-org").focus();$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(b)},clientFilter=
function(){var a={op:"client_spisok",find:$.trim($("#find")._search("val"))},b="";$(".filter")[a.find?"hide":"show"]();a.find&&(b+=".find="+escape(a.find));VK.callMethod("setLocation",hashLoc+b);_cookie("client_find",escape(a.find));return a},clientSpisok=function(){var a=$(".result");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,clientFilter(),function(b){a.removeClass("busy");b.success&&(a.html(b.result),$(".left").html(b.spisok))},"json"))},stockFilter=function(){return{op:"stock_spisok",
find:$.trim($("#find")._search("val"))}},stockSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,stockFilter(),function(a){$("#mainLinks").removeClass("busy");$(".result").html(a.result);$("#spisok").html(a.spisok)},"json")};
$.fn.clientSel=function(a){function b(b){b={op:"client_sel",val:b||"",client_id:a.client_id};c._select("process");$.post(AJAX_MAIN,b,function(b){c._select("cancel");b.success&&(c._select(b.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){},funcAdd:function(){}},a);a.add&&(a.add=function(){clientAdd(function(b){var h=[];h.push(b);c._select(h);c._select(b.uid);a.funcAdd(b)})});c._select({width:a.width,
title0:"Начните вводить данные клиента...",spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:b});b();return c};
$.fn.productList=function(a){function b(a){var b=h+g,d=b+"id",e=b+"subid",f=b+"count",k=b+"x";m.before('<table id="ptab'+g+'" class="ptab" val="'+g+'"><tr><td class="td"><input type="hidden" id="'+d+'" value="'+(a[0]||0)+'" /><input type="hidden" id="'+e+'" value="'+(a[1]||0)+'" /><table class="doptab"><tr><td class="lab">Ширина:<td><input type="text" id="'+k+'" class="size" /> м.<tr><td class="lab">Высота:<td><input type="text" id="'+(b+"y")+'" class="size" /> м.<tr><td class="lab">Количество:<td><input type="text" id="'+
f+'" value="'+(a[2]||"")+'" class="count" maxlength="3" /> шт.</table><td class="td">'+(1<g?'<div class="img_del"></div>':"")+"</table>");var l=$("#ptab"+g);l.find(".img_del").click(function(){l.remove()});$("#"+d)._select({width:170,title0:"Не указано",spisok:CATEGORY_SPISOK,func:function(a){$("#"+e)._select("remove").val(0);0<a&&CATEGORY_SUB_SPISOK[a]&&c(a,e,k);$("#"+k).focus();$("#"+f).val(a?1:"")}});c(a[0]||0,e,k);g++}function c(a,b,d){0!=a&&CATEGORY_SUB_SPISOK[a]&&$("#"+b)._select({width:160,
title0:"Подкатегория не указана",spisok:CATEGORY_SUB_SPISOK[a],func:function(){$("#"+d).focus()}})}var d=$(this),h=d.attr("id"),g=1,e;if("string"==typeof a&&"get"==a){a=d.find(".ptab");d=[];for(e=0;e<a.length;e++){var k=a.eq(e),f=h+k.attr("val"),k=$("#"+f+"id").val(),p=$("#"+f+"subid").val(),l=_cena($("#"+f+"x").val()),n=_cena($("#"+f+"y").val()),f=$("#"+f+"count").val();if(0!=k){if(!l||!n)return"size_error";if(!REGEXP_NUMERIC.test(f)||0==f)return"count_error";d.push(k+":"+p+":"+l+":"+n+":"+f)}}return 0==
d.length?!1:d.join(";")}d.html('<div class="_product-list"><a class="add">Добавить поле</a></div>');var m=d.find(".add");m.click(b);if("object"==typeof a)for(e=0;e<a.length;e++)b(a[e]);else b([]);return d};
$(document).ajaxSuccess(function(a,b,c){function d(){var a={op:"pin_enter",pin:$.trim($("#tpin").val())};a.pin?3>a.pin.length?(h("Длина пин-кода от 3 до 10 символов"),$("#tpin").focus()):(g.process(),$.post(AJAX_MAIN,a,function(a){a.success?g.close():a.max?location.reload():(g.abort(),h(a.text),$("#tpin").val("").focus())},"json")):(h("Не заполнено поле"),$("#tpin").focus())}function h(a){g.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:62,indent:50,show:1,remove:1})}if(b.responseJSON.pin){var g=
_dialog({width:250,head:"Подтверждение пин-кода",content:'<table class="setup-tab"><tr><td colspan="2"><div class="_info">Истекло время действия пин-кода. Требуется подтверждение.</div><tr><td class="label">Пин-код:<td><input id="tpin" type="password" maxlength="10" /></table>',butSubmit:"Подтвердить",butCancel:"",submit:d});$("#tpin").focus().keyEnter(d)}}).on("click","#client ._next",function(){var a=$(this),b=clientFilter();a.hasClass("busy")||(b.page=a.attr("val"),a.addClass("busy"),$.post(AJAX_MAIN,
b,function(b){b.success?a.after(b.spisok).remove():a.removeClass("busy")},"json"))}).on("click","#client #filter_clear",function(){$("#find")._search("clear");clientSpisok()}).on("click",".zayav_add",function(){window.CLIENT||(CLIENT={id:0,fio:""});var a=_dialog({width:550,top:30,head:"Внесение новой заявки",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделия:<td id="product"><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var b,c={op:"zayav_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),comm:$("#comm").val()};0==c.client_id?b="Не выбран клиент":c.product?"size_error"==c.product?b="Некорректно введён размер изделия":"count_error"==c.product?b="Некорректно введено количество изделий":(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+b.id):a.abort()},"json")):b="Не выбраны изделия";b&&a.bottom.vkHint({msg:'<SPAN class="red">'+
b+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});CLIENT.id||$("#client_id").clientSel({add:1});$("#product").productList();$("#comm").autosize()}).on("click","#setup_category .add",function(){function a(){var a={op:"category_add",name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,
show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:440,head:"Добавление новой категории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_category .img_edit",function(){function a(){var a={op:"category_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),
sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+b.find(".name a").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование категории",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click",
"#setup_category .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление категории",content:"<center><b>Подтвердите удаление категории.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"category_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено."),sortable()):b.abort()},"json")}})}).on("click","#setup_categorysub .add",function(){function a(){var a=
{op:"categorysub_add",category_id:CATEGORY_ID,name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено.")):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:440,head:"Добавление новой подкатегории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',
submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_categorysub .img_edit",function(){function a(){var a={op:"categorysub_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),
b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+b.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование подкатегории",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_categorysub .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление подкатегории",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=
a[0].tagName;)a=a.parent();var c={op:"categorysub_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено.")):b.abort()},"json")}})}).ready(function(){$("#client").length&&($("#find")._search({width:602,focus:1,enter:1,txt:"Введите текст и нажмите Enter",func:clientSpisok}).inp(C.find),$("#buttonCreate").click(clientAdd));$("#client-info").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",client_id:CLIENT.id,
org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};a.fio?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),c.close(),_msg("Данные клиента изменены")):(b(a.text),c.abort())},"json")):(b("Обязательно укажите название организации или контактное лицо"),$("#ca-org").focus())}function b(a){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:110,indent:70,show:1,
remove:1})}var c=_dialog({head:"Редактирование данных клиента",top:30,width:450,content:'<table class="client-add e"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100" value="'+CLIENT.org+'"><tr><td class="label">Контактное лицо:<td><input type="text" id="ca-fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="ca-telefon" maxlength="100" value="'+CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100" value="'+
CLIENT.adres+'"></table>',butSubmit:"Сохранить",submit:a});$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Клиент удален!"),location.href=URL+"&p=client"):a.abort()},"json")}})}));$("#stock").length&&($(".vkButton").click(function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",left:130,top:-47,indent:50,show:1,remove:1})}var b='<table id="stock-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="category_id" /><a href="'+URL+'&p=setup&d=stock" class="img_edit'+_tooltip("Настроить категорию комплектующих",-220,"r")+'</a><tr><td class="label">Наименование:<td><input type="text" id="name" /><tr><td class="label">Единица измерения:<td><input type="hidden" id="measure" /><tr><td class="label">Расход на м&sup2;:<td><input type="text" id="expense" /></table>',
c=_dialog({top:70,width:450,head:"Внесение новой позиции склада",content:b,submit:function(){var b={op:"stock_add",category_id:$("#category_id").val(),name:$.trim($("#name").val()),measure:1*$("#measure").val(),expense:$.trim($("#expense").val())};b.name?b.measure?b.expense&&!REGEXP_NUMERIC.test(b.expense)?a("Некорректно указан расход на м&sup2;"):(c.process(),$.post(AJAX_MAIN,b,function(a){c.abort();a.success&&(c.close(),stockSpisok())},"json")):a("Не указана единица измерения"):a("Не указано наименование")}});
$("#category_id")._select({width:270,title0:"Не выбрана",spisok:STOCK_SPISOK});$("#measure")._select({width:90,title0:"Не указана",spisok:MEASURE_SPISOK});$("#name").focus()}),$("#find")._search({width:250,focus:1,txt:"Быстрый поиск...",enter:1,func:stockSpisok}).inp(STOCK.find))});
