var hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d&&(hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""));break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}VK.callMethod("setLocation",hashLoc)}},clientAdd=function(a){function d(){var b={op:"client_add",org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};
b.org||b.fio?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Новый клиент внесён"),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Обязательно укажите название организации или контактное лицо</SPAN>',top:-47,left:98,indent:80,show:1,remove:1}),$("#ca-org").focus())}var c=_dialog({width:450,head:"Добавление нoвого клиента",content:'<table class="client-add"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100"><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="ca-fio" maxlength="100"><tr><td class="label">Телефоны:<td><input type="text" id="ca-telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100"></table>',
submit:d});$("#ca-org").focus();$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(d)},clientFilter=function(){var a={op:"client_spisok",find:$.trim($("#find")._search("val"))},d="";$(".filter")[a.find?"hide":"show"]();a.find&&(d+=".find="+escape(a.find));VK.callMethod("setLocation",hashLoc+d);_cookie("client_find",escape(a.find));return a},clientSpisok=function(){var a=$(".result");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,clientFilter(),function(d){a.removeClass("busy");d.success&&
(a.html(d.result),$(".left").html(d.spisok))},"json"))};
$.fn.clientSel=function(a){function d(b){b={op:"client_sel",val:b||"",client_id:a.client_id};c._select("process");$.post(AJAX_MAIN,b,function(b){c._select("cancel");b.success&&(c._select(b.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){},funcAdd:function(){}},a);a.add&&(a.add=function(){clientAdd(function(b){var d=[];d.push(b);c._select(d);c._select(b.uid);a.funcAdd(b)})});c._select({width:a.width,
title0:"Начните вводить данные клиента...",spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:d});d();return c};
$(document).ajaxSuccess(function(a,d,c){function b(){var a={op:"pin_enter",pin:$.trim($("#tpin").val())};a.pin?3>a.pin.length?(f("Длина пин-кода от 3 до 10 символов"),$("#tpin").focus()):(e.process(),$.post(AJAX_MAIN,a,function(a){a.success?e.close():a.max?location.reload():(e.abort(),f(a.text),$("#tpin").val("").focus())},"json")):(f("Не заполнено поле"),$("#tpin").focus())}function f(a){e.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:62,indent:50,show:1,remove:1})}if(d.responseJSON.pin){var e=
_dialog({width:250,head:"Подтверждение пин-кода",content:'<table class="setup-tab"><tr><td colspan="2"><div class="_info">Истекло время действия пин-кода. Требуется подтверждение.</div><tr><td class="label">Пин-код:<td><input id="tpin" type="password" maxlength="10" /></table>',butSubmit:"Подтвердить",butCancel:"",submit:b});$("#tpin").focus().keyEnter(b)}}).on("click","#client ._next",function(){var a=$(this),d=clientFilter();a.hasClass("busy")||(d.page=a.attr("val"),a.addClass("busy"),$.post(AJAX_MAIN,
d,function(c){c.success?a.after(c.spisok).remove():a.removeClass("busy")},"json"))}).on("click","#client #filter_clear",function(){$("#find")._search("clear");clientSpisok()}).ready(function(){$("#client").length&&($("#find")._search({width:602,focus:1,enter:1,txt:"Введите текст и нажмите Enter",func:clientSpisok}).inp(C.find),$("#buttonCreate").click(clientAdd));$("#client-info").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",client_id:CLIENT.id,org:$.trim($("#ca-org").val()),
fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};a.fio?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),c.close(),_msg("Данные клиента изменены")):(d(a.text),c.abort())},"json")):(d("Обязательно укажите название организации или контактное лицо"),$("#ca-org").focus())}function d(a){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:110,indent:70,show:1,remove:1})}var c=_dialog({head:"Редактирование данных клиента",
top:30,width:450,content:'<table class="client-add e"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100" value="'+CLIENT.org+'"><tr><td class="label">Контактное лицо:<td><input type="text" id="ca-fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="ca-telefon" maxlength="100" value="'+CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100" value="'+CLIENT.adres+'"></table>',
butSubmit:"Сохранить",submit:a});$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var d={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,d,function(c){c.success?(a.close(),_msg("Клиент удален!"),location.href=URL+"&p=client"):a.abort()},"json")}})}));$("#stock").length&&($(".vkButton").click(function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",left:110,top:-47,indent:50,show:1,remove:1})}var d='<table id="stock-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="category_id" /><div class="img_edit'+_tooltip("Настроить категорию комплектующих",-120)+'</div><tr><td class="label">Наименование:<td><input type="text" id="name" /></table>',c=_dialog({top:70,width:450,head:"Внесение новой позиции склада",content:d,submit:function(){var b={op:"stock_add",category_id:$("#category_id").val(),name:$.trim($("#name").val())};
0==b.name_id?a("Не указано наименование запчасти"):0==b.device_id?a("Не выбрано устройство"):0==b.vendor_id?a("Не выбран производитель"):0==b.model_id?a("Не выбрана модель"):(c.process(),$.post(AJAX_WS,b,function(a){c.abort();a.success&&(c.close(),$("#zp_name")._select(b.name_id),$("#dev").device({width:220,type_no:1,device_ids:WS_DEVS,device_id:b.device_id,vendor_id:b.vendor_id,model_id:b.model_id,func:zpSpisok}),zpSpisok())},"json"))}});$("#category_id")._select({width:270,title0:"Категория не выбрана",
spisok:[]});$("#name").focus()}),$("#find")._search({width:250,focus:1,txt:"Быстрый поиск...",enter:1}).inp(ZP.find))});
