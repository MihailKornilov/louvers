var AJAX_SETUP=APP_HTML+"/ajax/setup.php?"+VALUES,hashLoc,hashSet=function(b){if(b||b.p){hashLoc=b.p;switch(b.p){case "client":"info"==b.d&&(hashLoc+="_"+b.id);break;case "zayav":"info"==b.d?hashLoc+="_"+b.id:"add"==b.d&&(hashLoc+="_add"+(REGEXP_NUMERIC.test(b.id)?"_"+b.id:""));break;default:b.d&&(hashLoc+="_"+b.d,b.d1&&(hashLoc+="_"+b.d1))}VK.callMethod("setLocation",hashLoc)}},clientAdd=function(b){function a(){var a={op:"client_add",org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),
telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};a.org||a.fio?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(c.close(),_msg("Новый клиент внесён"),"function"==typeof b?b(a):document.location.href=URL+"&p=client&d=info&id="+a.uid):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Обязательно укажите название организации или контактное лицо</SPAN>',top:-47,left:98,indent:80,show:1,remove:1}),$("#ca-org").focus())}var c=_dialog({width:450,head:"Добавление нoвого клиента",
content:'<table class="client-add"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100"><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="ca-fio" maxlength="100"><tr><td class="label">Телефоны:<td><input type="text" id="ca-telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100"></table>',submit:a});$("#ca-org").focus();$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(a)},clientFilter=
function(){var b={op:"client_spisok",find:$.trim($("#find")._search("val"))},a="";$(".filter")[b.find?"hide":"show"]();b.find&&(a+=".find="+escape(b.find));VK.callMethod("setLocation",hashLoc+a);_cookie("client_find",escape(b.find));return b},clientSpisok=function(){var b=$(".result");b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_MAIN,clientFilter(),function(a){b.removeClass("busy");a.success&&(b.html(a.result),$(".left").html(a.spisok))},"json"))},stockFilter=function(){return{op:"stock_spisok",
find:$.trim($("#find")._search("val"))}},stockSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,stockFilter(),function(b){$("#mainLinks").removeClass("busy");$(".result").html(b.result);$("#spisok").html(b.spisok)},"json")};
$.fn.clientSel=function(b){function a(a){a={op:"client_sel",val:a||"",client_id:b.client_id};c._select("process");$.post(AJAX_MAIN,a,function(a){c._select("cancel");a.success&&(c._select(a.spisok),b.client_id&&(c._select(b.client_id),b.client_id=0))},"json")}var c=$(this);b=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){},funcAdd:function(){}},b);b.add&&(b.add=function(){clientAdd(function(a){var g=[];g.push(a);c._select(g);c._select(a.uid);b.funcAdd(a)})});c._select({width:b.width,
title0:"Начните вводить данные клиента...",spisok:[],write:1,nofind:"Клиентов не найдено",func:b.func,funcAdd:b.add,funcKeyup:a});a();return c};
$.fn.productList=function(b){function a(a){function b(a){0!=a&&CATEGORY_SUB_SPISOK[a]&&$("#"+f)._select({width:160,title0:"Подкатегория не указана",spisok:CATEGORY_SUB_SPISOK[a],func:function(a){$("#"+h).focus();$("#"+k)._select(CLOTH_NAME_SPISOK[a]?CLOTH_NAME_SPISOK[a]:[]);$("#"+k)._select(0);$("#"+l)._select(CLOTH_COLOR_SPISOK[a]?CLOTH_COLOR_SPISOK[a]:[]);$("#"+l)._select(0)}})}var c=d+g,e=c+"id",f=c+"subid",h=c+"x",k=c+"cloth_name",l=c+"cloth_color",m=c+"count";p.before('<div id="ptab'+g+'" class="ptab" val="'+
g+'"><tr><div><input type="hidden" id="'+e+'" value="'+(a[0]||0)+'" /><input type="hidden" id="'+f+'" value="'+(a[1]||0)+'" />'+(1<g?'<div class="img_del"></div>':"")+'</div><table class="doptab"><tr><td class="lab">Ширина:<td><input type="text" id="'+h+'" class="size" maxlength="5" /> мм.<span class="lab">Высота:</span> <input type="text" id="'+(c+"y")+'" class="size" maxlength="5" /> мм.<tr><td class="lab">Наименование ткани:<td><input type="hidden" id="'+k+'" /><tr><td class="lab">Цвет ткани:<td><input type="hidden" id="'+
l+'" /><tr><td class="lab">Кол-во:<td><input type="text" id="'+m+'" value="'+(a[2]||"")+'" class="count" maxlength="3" /> шт.</table></div>');var n=$("#ptab"+g);n.find(".img_del").click(function(){n.remove()});$("#"+e)._select({width:170,title0:"Не указано",spisok:CATEGORY_SPISOK,func:function(a){$("#"+f)._select("remove").val(0);0<a&&CATEGORY_SUB_SPISOK[a]&&b(a);$("#"+h).focus();$("#"+k)._select([]);$("#"+k)._select(0);$("#"+l)._select([]);$("#"+l)._select(0);$("#"+m).val(a?1:"")}});$("#"+k)._select({width:220,
title0:"Наименование не указано",spisok:[]});$("#"+l)._select({width:220,title0:"Цвет не указан",spisok:[]});b(a[0]||0);g++}var c=$(this),d=c.attr("id"),g=1,e;if("string"==typeof b&&"get"==b){b=c.find(".ptab");c=[];for(e=0;e<b.length;e++){var h=b.eq(e),f=d+h.attr("val"),h=$("#"+f+"id").val(),q=$("#"+f+"subid").val(),m=$("#"+f+"x").val(),r=$("#"+f+"cloth_name").val(),s=$("#"+f+"cloth_color").val(),n=$("#"+f+"y").val(),f=$("#"+f+"count").val();if(0!=h){if(!REGEXP_NUMERIC.test(m)||0==m||!REGEXP_NUMERIC.test(n)||
0==n)return"size_error";if(!REGEXP_NUMERIC.test(f)||0==f)return"count_error";c.push(h+":"+q+":"+m+":"+n+":"+r+":"+s+":"+f)}}return 0==c.length?!1:c.join(";")}c.html('<div class="_product-list"><a class="add">Добавить поле</a></div>');var p=c.find(".add");p.click(a);if("object"==typeof b)for(e=0;e<b.length;e++)a(b[e]);else a([]);return c};
$(document).ajaxSuccess(function(b,a,c){function d(){var a={op:"pin_enter",pin:$.trim($("#tpin").val())};a.pin?3>a.pin.length?(g("Длина пин-кода от 3 до 10 символов"),$("#tpin").focus()):(e.process(),$.post(AJAX_MAIN,a,function(a){a.success?e.close():a.max?location.reload():(e.abort(),g(a.text),$("#tpin").val("").focus())},"json")):(g("Не заполнено поле"),$("#tpin").focus())}function g(a){e.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:62,indent:50,show:1,remove:1})}if(a.responseJSON.pin){var e=
_dialog({width:250,head:"Подтверждение пин-кода",content:'<table class="setup-tab"><tr><td colspan="2"><div class="_info">Истекло время действия пин-кода. Требуется подтверждение.</div><tr><td class="label">Пин-код:<td><input id="tpin" type="password" maxlength="10" /></table>',butSubmit:"Подтвердить",butCancel:"",submit:d});$("#tpin").focus().keyEnter(d)}}).on("click","#client ._next",function(){var b=$(this),a=clientFilter();b.hasClass("busy")||(a.page=b.attr("val"),b.addClass("busy"),$.post(AJAX_MAIN,
a,function(a){a.success?b.after(a.spisok).remove():b.removeClass("busy")},"json"))}).on("click","#client #filter_clear",function(){$("#find")._search("clear");clientSpisok()}).on("click",".zayav_add",function(){window.CLIENT||(CLIENT={id:0,fio:""});var b=_dialog({width:550,top:30,head:"Внесение новой заявки",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделия:<td id="product"><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var a,c={op:"zayav_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),comm:$("#comm").val()};0==c.client_id?a="Не выбран клиент":c.product?"size_error"==c.product?a="Некорректно введён размер изделия":"count_error"==c.product?a="Некорректно введено количество изделий":(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+a.id):b.abort()},"json")):a="Не выбраны изделия";a&&b.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});CLIENT.id||$("#client_id").clientSel({add:1});$("#product").productList();$("#comm").autosize()}).on("click",".zayav_unit",function(){document.location.href=URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#setup_category .add",function(){function b(){var b={op:"category_add",name:$("#name").val()};b.name?(a.process(),$.post(AJAX_SETUP,b,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Внесено!"),sortable()):a.abort()},
"json")):(a.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var a=_dialog({width:440,head:"Добавление новой категории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:b});$("#name").focus().keyEnter(b)}).on("click","#setup_category .img_edit",function(){function b(){var a={op:"category_edit",id:c,name:$("#name").val()};
a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var a=$(this);"DD"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),a='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+a.find(".name a").html()+
'" /></table>',d=_dialog({width:440,head:"Редактирование категории",content:a,butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b)}).on("click","#setup_category .img_del",function(){var b=$(this),a=_dialog({top:90,width:300,head:"Удаление категории",content:"<center><b>Подтвердите удаление категории.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=b[0].tagName;)b=b.parent();var c={op:"category_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($(".spisok").html(b.html),
a.close(),_msg("Удалено."),sortable()):a.abort()},"json")}})}).on("click","#setup_categorysub .add",function(){function b(){var b={op:"categorysub_add",category_id:CATEGORY_ID,name:$("#name").val()};b.name?(a.process(),$.post(AJAX_SETUP,b,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Внесено.")):a.abort()},"json")):(a.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var a=_dialog({width:440,
head:"Добавление новой подкатегории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:b});$("#name").focus().keyEnter(b)}).on("click","#setup_categorysub .img_edit",function(){function b(){var a={op:"categorysub_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",
top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),a='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+a.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование подкатегории",content:a,butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b)}).on("click","#setup_categorysub .img_del",function(){var b=$(this),a=_dialog({top:90,
width:300,head:"Удаление подкатегории",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=b[0].tagName;)b=b.parent();var c={op:"categorysub_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($(".spisok").html(b.html),a.close(),_msg("Удалено.")):a.abort()},"json")}})}).on("click","#cloth_name_add",function(){function b(){var b={op:"cloth_name_add",category_sub_id:CATEGORY_SUB_ID,name:$("#name").val()};b.name?(a.process(),
$.post(AJAX_SETUP,b,function(b){b.success?($("#name_spisok").html(b.html),a.close(),_msg("Внесено.")):a.abort()},"json")):(a.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var a=_dialog({width:440,head:"Добавление наименования ткани",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:b});$("#name").focus().keyEnter(b)}).on("click",
".cloth_name_edit",function(){function b(){var a={op:"cloth_name_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#name_spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),a='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+
a.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование наименования ткани",content:a,butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b)}).on("click",".cloth_name_del",function(){var b=$(this),a=_dialog({top:90,width:300,head:"Удаление наименования ткани",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=b[0].tagName;)b=b.parent();var c={op:"cloth_name_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,
function(b){b.success?($("#name_spisok").html(b.html),a.close(),_msg("Удалено.")):a.abort()},"json")}})}).on("click","#cloth_color_add",function(){function b(){var b={op:"cloth_color_add",category_sub_id:CATEGORY_SUB_ID,name:$("#name").val()};b.name?(a.process(),$.post(AJAX_SETUP,b,function(b){b.success?($("#color_spisok").html(b.html),a.close(),_msg("Внесено.")):a.abort()},"json")):(a.bottom.vkHint({msg:"<SPAN class=red>Не указан цвет</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}
$(this);var a=_dialog({width:440,head:"Добавление цвета ткани",content:'<table class="setup-tab"><tr><td class="label r">Цвет:<td><input id="name" type="text" maxlength="200" /></table>',submit:b});$("#name").focus().keyEnter(b)}).on("click",".cloth_color_edit",function(){function b(){var a={op:"cloth_color_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#color_spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указан цвет</SPAN>",
top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var c=a.attr("val"),a='<table class="setup-tab"><tr><td class="label r">Цвет:<td><input id="name" type="text" maxlength="200" value="'+a.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование цвета ткани",content:a,butSubmit:"Сохранить",submit:b});$("#name").focus().keyEnter(b)}).on("click",".cloth_color_del",function(){var b=$(this),a=_dialog({top:90,width:300,
head:"Удаление цвета ткани",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=b[0].tagName;)b=b.parent();var c={op:"cloth_color_del",id:b.attr("val")};a.process();$.post(AJAX_SETUP,c,function(b){b.success?($("#color_spisok").html(b.html),a.close(),_msg("Удалено.")):a.abort()},"json")}})}).ready(function(){$("#client").length&&($("#find")._search({width:602,focus:1,enter:1,txt:"Введите текст и нажмите Enter",func:clientSpisok}).inp(C.find),$("#buttonCreate").click(clientAdd));
$("#client-info").length&&($(".cedit").click(function(){function b(){var b={op:"client_edit",client_id:CLIENT.id,org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};b.fio?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(CLIENT=b,$(".left:first").html(b.html),c.close(),_msg("Данные клиента изменены")):(a(b.text),c.abort())},"json")):(a("Обязательно укажите название организации или контактное лицо"),$("#ca-org").focus())}
function a(a){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:110,indent:70,show:1,remove:1})}var c=_dialog({head:"Редактирование данных клиента",top:30,width:450,content:'<table class="client-add e"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100" value="'+CLIENT.org+'"><tr><td class="label">Контактное лицо:<td><input type="text" id="ca-fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="ca-telefon" maxlength="100" value="'+
CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100" value="'+CLIENT.adres+'"></table>',butSubmit:"Сохранить",submit:b});$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(b)}),$(".cdel").click(function(){var b=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var a={op:"client_del",id:CLIENT.id};b.process();$.post(AJAX_MAIN,a,function(a){a.success?(b.close(),
_msg("Клиент удален!"),location.href=URL+"&p=client"):b.abort()},"json")}})}));$("#stock").length&&($(".vkButton").click(function(){function b(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",left:130,top:-47,indent:50,show:1,remove:1})}var a='<table id="stock-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="category_id" /><a href="'+URL+'&p=setup&d=stock" class="img_edit'+_tooltip("Настроить категорию комплектующих",-220,"r")+'</a><tr><td class="label">Наименование:<td><input type="text" id="name" /><tr><td class="label">Единица измерения:<td><input type="hidden" id="measure" /><tr><td class="label">Расход на м&sup2;:<td><input type="text" id="expense" /></table>',
c=_dialog({top:70,width:450,head:"Внесение новой позиции склада",content:a,submit:function(){var a={op:"stock_add",category_id:$("#category_id").val(),name:$.trim($("#name").val()),measure:1*$("#measure").val(),expense:$.trim($("#expense").val())};a.name?a.measure?a.expense&&!REGEXP_NUMERIC.test(a.expense)?b("Некорректно указан расход на м&sup2;"):(c.process(),$.post(AJAX_MAIN,a,function(a){c.abort();a.success&&(c.close(),stockSpisok())},"json")):b("Не указана единица измерения"):b("Не указано наименование")}});
$("#category_id")._select({width:270,title0:"Не выбрана",spisok:STOCK_SPISOK});$("#measure")._select({width:90,title0:"Не указана",spisok:MEASURE_SPISOK});$("#name").focus()}),$("#find")._search({width:250,focus:1,txt:"Быстрый поиск...",enter:1,func:stockSpisok}).inp(STOCK.find))});
