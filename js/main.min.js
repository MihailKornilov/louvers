var AJAX_SETUP=APP_HTML+"/ajax/setup.php?"+VALUES,hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d&&(hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""));break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}VK.callMethod("setLocation",hashLoc)}},clientAdd=function(a){function b(){var b={op:"client_add",org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),
telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};b.org||b.fio?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Новый клиент внесён"),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Обязательно укажите название организации или контактное лицо</SPAN>',top:-47,left:98,indent:80,show:1,remove:1}),$("#ca-org").focus())}var c=_dialog({width:450,head:"Добавление нoвого клиента",
content:'<table class="client-add"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100"><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="ca-fio" maxlength="100"><tr><td class="label">Телефоны:<td><input type="text" id="ca-telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100"></table>',submit:b});$("#ca-org").focus();$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(b)},clientFilter=
function(){var a={op:"client_spisok",find:$.trim($("#find")._search("val"))},b="";$(".filter")[a.find?"hide":"show"]();a.find&&(b+=".find="+escape(a.find));VK.callMethod("setLocation",hashLoc+b);_cookie("client_find",escape(a.find));return a},clientSpisok=function(){var a=$(".result");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,clientFilter(),function(b){a.removeClass("busy");b.success&&(a.html(b.result),$(".left").html(b.spisok))},"json"))},stockFilter=function(){return{op:"stock_spisok",
find:$.trim($("#find")._search("val"))}},stockSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,stockFilter(),function(a){$("#mainLinks").removeClass("busy");$(".result").html(a.result);$("#spisok").html(a.spisok)},"json")};
$.fn.clientSel=function(a){function b(b){b={op:"client_sel",val:b||"",client_id:a.client_id};c._select("process");$.post(AJAX_MAIN,b,function(b){c._select("cancel");b.success&&(c._select(b.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){},funcAdd:function(){}},a);a.add&&(a.add=function(){clientAdd(function(b){var e=[];e.push(b);c._select(e);c._select(b.uid);a.funcAdd(b)})});c._select({width:a.width,
title0:"Начните вводить данные клиента...",spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:b});b();return c};
$(document).ajaxSuccess(function(a,b,c){function d(){var a={op:"pin_enter",pin:$.trim($("#tpin").val())};a.pin?3>a.pin.length?(e("Длина пин-кода от 3 до 10 символов"),$("#tpin").focus()):(f.process(),$.post(AJAX_MAIN,a,function(a){a.success?f.close():a.max?location.reload():(f.abort(),e(a.text),$("#tpin").val("").focus())},"json")):(e("Не заполнено поле"),$("#tpin").focus())}function e(a){f.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:62,indent:50,show:1,remove:1})}if(b.responseJSON.pin){var f=
_dialog({width:250,head:"Подтверждение пин-кода",content:'<table class="setup-tab"><tr><td colspan="2"><div class="_info">Истекло время действия пин-кода. Требуется подтверждение.</div><tr><td class="label">Пин-код:<td><input id="tpin" type="password" maxlength="10" /></table>',butSubmit:"Подтвердить",butCancel:"",submit:d});$("#tpin").focus().keyEnter(d)}}).on("click","#client ._next",function(){var a=$(this),b=clientFilter();a.hasClass("busy")||(b.page=a.attr("val"),a.addClass("busy"),$.post(AJAX_MAIN,
b,function(b){b.success?a.after(b.spisok).remove():a.removeClass("busy")},"json"))}).on("click","#client #filter_clear",function(){$("#find")._search("clear");clientSpisok()}).on("click","#setup_stock .add",function(){function a(){var a={op:"stock_add",name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,
left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:440,head:"Добавление нового категории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_stock .img_edit",function(){function a(){var a={op:"stock_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),
d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+b.find(".name").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование категории",content:b,butSubmit:"Сохранить",
submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_stock .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление вида платежа",content:"<center><b>Подтвердите удаление категории.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"stock_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено!"),sortable()):b.abort()},"json")}})}).ready(function(){$("#client").length&&
($("#find")._search({width:602,focus:1,enter:1,txt:"Введите текст и нажмите Enter",func:clientSpisok}).inp(C.find),$("#buttonCreate").click(clientAdd));$("#client-info").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",client_id:CLIENT.id,org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};a.fio?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),
c.close(),_msg("Данные клиента изменены")):(b(a.text),c.abort())},"json")):(b("Обязательно укажите название организации или контактное лицо"),$("#ca-org").focus())}function b(a){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:110,indent:70,show:1,remove:1})}var c=_dialog({head:"Редактирование данных клиента",top:30,width:450,content:'<table class="client-add e"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100" value="'+CLIENT.org+'"><tr><td class="label">Контактное лицо:<td><input type="text" id="ca-fio" maxlength="100" value="'+
CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="ca-telefon" maxlength="100" value="'+CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100" value="'+CLIENT.adres+'"></table>',butSubmit:"Сохранить",submit:a});$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b=
{op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Клиент удален!"),location.href=URL+"&p=client"):a.abort()},"json")}})}));$("#stock").length&&($(".vkButton").click(function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",left:130,top:-47,indent:50,show:1,remove:1})}var b='<table id="stock-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="category_id" /><a href="'+URL+'&p=setup&d=stock" class="img_edit'+_tooltip("Настроить категорию комплектующих",
-220,"r")+'</a><tr><td class="label">Наименование:<td><input type="text" id="name" /><tr><td class="label">Единица измерения:<td><input type="hidden" id="measure" /><tr><td class="label">Расход на м&sup2;:<td><input type="text" id="expense" /></table>',c=_dialog({top:70,width:450,head:"Внесение новой позиции склада",content:b,submit:function(){var b={op:"stock_add",category_id:$("#category_id").val(),name:$.trim($("#name").val()),measure:1*$("#measure").val(),expense:$.trim($("#expense").val())};
b.name?b.measure?b.expense&&!REGEXP_NUMERIC.test(b.expense)?a("Некорректно указан расход на м&sup2;"):(c.process(),$.post(AJAX_MAIN,b,function(a){c.abort();a.success&&(c.close(),stockSpisok())},"json")):a("Не указана единица измерения"):a("Не указано наименование")}});$("#category_id")._select({width:270,title0:"Не выбрана",spisok:STOCK_SPISOK});$("#measure")._select({width:90,title0:"Не указана",spisok:MEASURE_SPISOK});$("#name").focus()}),$("#find")._search({width:250,focus:1,txt:"Быстрый поиск...",
enter:1,func:stockSpisok}).inp(STOCK.find))});
