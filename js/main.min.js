var AJAX_SETUP=APP_HTML+"/ajax/setup.php?"+VALUES,hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d&&(hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""));break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}VK.callMethod("setLocation",hashLoc)}},clientAdd=function(a){function b(){var b={op:"client_add",org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),
telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};b.org||b.fio?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Новый клиент внесён"),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Обязательно укажите название организации или контактное лицо</SPAN>',top:-47,left:98,indent:80,show:1,remove:1}),$("#ca-org").focus())}var c=_dialog({width:450,head:"Добавление нoвого клиента",
content:'<table class="client-add"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100"><tr><td class="label">Контактное лицо (фио):<td><input type="text" id="ca-fio" maxlength="100"><tr><td class="label">Телефоны:<td><input type="text" id="ca-telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100"></table>',submit:b});$("#ca-org").focus();$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(b)},clientFilter=
function(){var a={op:"client_spisok",find:$.trim($("#find")._search("val"))},b="";$(".filter")[a.find?"hide":"show"]();a.find&&(b+=".find="+escape(a.find));VK.callMethod("setLocation",hashLoc+b);_cookie("client_find",escape(a.find));return a},clientSpisok=function(){var a=$(".result");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,clientFilter(),function(b){a.removeClass("busy");b.success&&(a.html(b.result),$(".left").html(b.spisok))},"json"))},stockFilter=function(){return{op:"stock_spisok",
find:$.trim($("#find")._search("val"))}},stockSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,stockFilter(),function(a){$("#mainLinks").removeClass("busy");$(".result").html(a.result);$("#spisok").html(a.spisok)},"json")};
$.fn.clientSel=function(a){function b(b){b={op:"client_sel",val:b||"",client_id:a.client_id};c._select("process");$.post(AJAX_MAIN,b,function(b){c._select("cancel");b.success&&(c._select(b.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){},funcAdd:function(){}},a);a.add&&(a.add=function(){clientAdd(function(b){var e=[];e.push(b);c._select(e);c._select(b.uid);a.funcAdd(b)})});c._select({width:a.width,
title0:"Начните вводить данные клиента...",spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:b});b();return c};
$.fn.productList=function(a){function b(a){function b(a){0!=a&&CATEGORY_SUB_SPISOK[a]&&$("#"+h)._select({width:160,title0:"Подкатегория не указана",spisok:CATEGORY_SUB_SPISOK[a],func:function(a){$("#"+g).focus();$("#"+k)._select(CLOTH_NAME_SPISOK[a]?CLOTH_NAME_SPISOK[a]:[]);$("#"+k)._select(0);$("#"+l)._select(CLOTH_COLOR_SPISOK[a]?CLOTH_COLOR_SPISOK[a]:[]);$("#"+l)._select(0)}})}var c=d+e,f=c+"id",h=c+"subid",g=c+"x",k=c+"cloth_name",l=c+"cloth_color",m=c+"count";p.before('<div id="ptab'+e+'" class="ptab" val="'+
e+'"><tr><div><input type="hidden" id="'+f+'" value="'+(a[0]||0)+'" /><input type="hidden" id="'+h+'" value="'+(a[1]||0)+'" />'+(1<e?'<div class="img_del"></div>':"")+'</div><table class="doptab"><tr><td class="lab">Ширина:<td><input type="text" id="'+g+'" class="size" maxlength="5" /> мм.<span class="lab">Высота:</span> <input type="text" id="'+(c+"y")+'" class="size" maxlength="5" /> мм.<tr><td class="lab">Наименование ткани:<td><input type="hidden" id="'+k+'" /><tr><td class="lab">Цвет ткани:<td><input type="hidden" id="'+
l+'" /><tr><td class="lab">Кол-во:<td><input type="text" id="'+m+'" value="'+(a[2]||"")+'" class="count" maxlength="3" /> шт.</table></div>');var n=$("#ptab"+e);n.find(".img_del").click(function(){n.remove()});$("#"+f)._select({width:170,title0:"Не указано",spisok:CATEGORY_SPISOK,func:function(a){$("#"+h)._select("remove").val(0);0<a&&CATEGORY_SUB_SPISOK[a]&&b(a);$("#"+g).focus();$("#"+k)._select([]);$("#"+k)._select(0);$("#"+l)._select([]);$("#"+l)._select(0);$("#"+m).val(a?1:"")}});$("#"+k)._select({width:220,
title0:"Наименование не указано",spisok:[]});$("#"+l)._select({width:220,title0:"Цвет не указан",spisok:[]});b(a[0]||0);e++}var c=$(this),d=c.attr("id"),e=1,f;if("string"==typeof a&&"get"==a){a=c.find(".ptab");c=[];for(f=0;f<a.length;f++){var h=a.eq(f),g=d+h.attr("val"),h=$("#"+g+"id").val(),q=$("#"+g+"subid").val(),m=$("#"+g+"x").val(),r=$("#"+g+"cloth_name").val(),s=$("#"+g+"cloth_color").val(),n=$("#"+g+"y").val(),g=$("#"+g+"count").val();if(0!=h){if(!REGEXP_NUMERIC.test(m)||0==m||!REGEXP_NUMERIC.test(n)||
0==n)return"size_error";if(!REGEXP_NUMERIC.test(g)||0==g)return"count_error";c.push(h+":"+q+":"+m+":"+n+":"+r+":"+s+":"+g)}}return 0==c.length?!1:c.join(";")}c.html('<div class="_product-list"><a class="add">Добавить поле</a></div>');var p=c.find(".add");p.click(b);if("object"==typeof a)for(f=0;f<a.length;f++)b(a[f]);else b([]);return c};
$(document).ajaxSuccess(function(a,b,c){function d(){var a={op:"pin_enter",pin:$.trim($("#tpin").val())};a.pin?3>a.pin.length?(e("Длина пин-кода от 3 до 10 символов"),$("#tpin").focus()):(f.process(),$.post(AJAX_MAIN,a,function(a){a.success?f.close():a.max?location.reload():(f.abort(),e(a.text),$("#tpin").val("").focus())},"json")):(e("Не заполнено поле"),$("#tpin").focus())}function e(a){f.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:62,indent:50,show:1,remove:1})}if(b.responseJSON.pin){var f=
_dialog({width:250,head:"Подтверждение пин-кода",content:'<table class="setup-tab"><tr><td colspan="2"><div class="_info">Истекло время действия пин-кода. Требуется подтверждение.</div><tr><td class="label">Пин-код:<td><input id="tpin" type="password" maxlength="10" /></table>',butSubmit:"Подтвердить",butCancel:"",submit:d});$("#tpin").focus().keyEnter(d)}}).on("click","#client ._next",function(){var a=$(this),b=clientFilter();a.hasClass("busy")||(b.page=a.attr("val"),a.addClass("busy"),$.post(AJAX_MAIN,
b,function(b){b.success?a.after(b.spisok).remove():a.removeClass("busy")},"json"))}).on("click","#client #filter_clear",function(){$("#find")._search("clear");clientSpisok()}).on("click",".zayav_add",function(){window.CLIENT||(CLIENT={id:0,fio:""});var a=_dialog({width:550,top:30,head:"Внесение новой заявки",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделия:<td id="product"><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var b,c={op:"zayav_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),comm:$("#comm").val()};0==c.client_id?b="Не выбран клиент":c.product?"size_error"==c.product?b="Некорректно введён размер изделия":"count_error"==c.product?b="Некорректно введено количество изделий":(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+b.id):a.abort()},"json")):b="Не выбраны изделия";b&&a.bottom.vkHint({msg:'<SPAN class="red">'+
b+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});CLIENT.id||$("#client_id").clientSel({add:1});$("#product").productList();$("#comm").autosize()}).on("click",".zayav_unit",function(){document.location.href=URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#setup_category .add",function(){function a(){var a={op:"category_add",name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},
"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:440,head:"Добавление новой категории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_category .img_edit",function(){function a(){var a={op:"category_edit",id:c,name:$("#name").val()};
a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+b.find(".name a").html()+
'" /></table>',d=_dialog({width:440,head:"Редактирование категории",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_category .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление категории",content:"<center><b>Подтвердите удаление категории.</b></center>",butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"category_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),
b.close(),_msg("Удалено."),sortable()):b.abort()},"json")}})}).on("click","#setup_categorysub .add",function(){function a(){var a={op:"categorysub_add",category_id:CATEGORY_ID,name:$("#name").val()};a.name?(b.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено.")):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({width:440,
head:"Добавление новой подкатегории",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_categorysub .img_edit",function(){function a(){var a={op:"categorysub_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",
top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="200" value="'+b.find(".name a").html()+'" /></table>',d=_dialog({width:440,head:"Редактирование подкатегории",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_categorysub .img_del",function(){var a=$(this),b=_dialog({top:90,
width:300,head:"Удаление подкатегории",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=a[0].tagName;)a=a.parent();var c={op:"categorysub_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено.")):b.abort()},"json")}})}).on("click","#feature_add",function(){function a(){var a={op:"feature_add",category_sub_id:CATEGORY_SUB_ID,name_id:1*$("#name_id").val(),name:$("#name").val(),
kod:$("#kod").val()};a.name_id?a.kod?(c.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#feature_spisok").html(a.html),c.close(),_msg("Внесено.")):c.abort()},"json")):(b("Не указан код"),$("#kod").focus()):b("Не выбрано название характеристики")}function b(a){c.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}$(this);var c=_dialog({width:410,head:"Добавление новой характеристики",content:'<table class="setup-tab"><tr><td><input type="hidden" id="name_id" /><td><input type="text" id="name" maxlength="200" /><tr><td class="label r">Код:<td><input type="text" id="kod" style="width:55px" maxlength="8" /></table>',
submit:a});$("#name").focus();$("#name,#kod").keyEnter(a);$("#name_id")._select({width:80,title0:"---",spisok:FEATURE_SPISOK,func:function(){$("#name").focus()}})}).on("click","#feature_spisok .img_edit",function(){function a(){var a={op:"feature_edit",id:d,category_sub_id:CATEGORY_SUB_ID,name_id:1*$("#name_id").val(),name:$("#name").val(),kod:$("#kod").val()};a.name_id?a.kod?(e.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#feature_spisok").html(a.html),e.close(),_msg("Сохранено.")):e.abort()},
"json")):(b("Не указан код"),$("#kod").focus()):b("Не выбрано название характеристики")}function b(a){e.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}for(var c=$(this);"TR"!=c[0].tagName;)c=c.parent();var d=c.attr("val"),c='<table class="setup-tab"><tr><td><input type="hidden" id="name_id" value="'+$("#name_id_"+d).val()+'" /><td><input type="text" id="name" maxlength="200" value="'+$("#name_"+d).val()+'" /><tr><td class="label r">Код:<td><input type="text" id="kod" style="width:55px" maxlength="8" value="'+
$("#kod_"+d).val()+'" /></table>',e=_dialog({width:440,head:"Редактирование характеристики",content:c,butSubmit:"Сохранить",submit:a});$("#name").focus();$("#name,#kod").keyEnter(a);$("#name_id")._select({width:70,title0:"---",spisok:FEATURE_SPISOK,func:function(){$("#name").focus()}})}).on("click","#feature_spisok .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление характеристики",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=
a[0].tagName;)a=a.parent();var c={op:"feature_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($("#feature_spisok").html(a.html),b.close(),_msg("Удалено.")):b.abort()},"json")}})}).on("click","#feature_spisok .color_add",function(){function a(){var a={op:"feature_color_add",feature_id:c,name:$("#name").val(),kod:$("#kod").val()};a.name?(e.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#feature_spisok").html(a.html),e.close(),_msg("Внесено.")):e.abort()},"json")):
(e.bottom.vkHint({msg:"<SPAN class=red>Не указан цвет</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),d=b.find("u").html(),b=b.find("b").html(),e=_dialog({top:40,width:400,head:"Добавление цвета",content:'<table class="setup-tab"><tr><td class="label r">'+d+":<td><b>"+b+'</b><tr><td class="label r">Цвет:<td><input id="name" type="text" maxlength="200" /><tr><td class="label r">Код:<td><input type="text" id="kod" style="width:55px" maxlength="8" /></table>',
submit:a});$("#name").focus();$("#name,#kod").keyEnter(a)}).on("click","#feature_spisok .color_edit",function(){function a(){var a={op:"feature_color_edit",id:c,name:$("#name").val(),kod:$("#kod").val()};a.name?(d.process(),$.post(AJAX_SETUP,a,function(a){a.success?($("#feature_spisok").html(a.html),d.close(),_msg("Сохранено.")):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указан цвет</SPAN>",top:-47,left:120,indent:50,show:1,remove:1}),$("#name").focus())}var b=$(this),c=b.attr("val");
b.find("u").html();b.find("b").html();var b='<table class="setup-tab"><tr><td class="label r">Цвет:<td><input id="name" type="text" maxlength="200" value="'+$("#color_name_"+c).val()+'" /><tr><td class="label r">Код:<td><input type="text" id="kod" style="width:55px" maxlength="8" value="'+$("#color_kod_"+c).val()+'" /></table>',d=_dialog({top:40,width:400,head:"Редактирование цвета",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus();$("#name,#kod").keyEnter(a)}).on("click","#feature_spisok .color_del",
function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление цвета",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var c={op:"feature_color_del",id:a.attr("val")};b.process();$.post(AJAX_SETUP,c,function(a){a.success?($("#feature_spisok").html(a.html),b.close(),_msg("Удалено.")):b.abort()},"json")}})}).ready(function(){$("#client").length&&($("#find")._search({width:602,focus:1,enter:1,txt:"Введите текст и нажмите Enter",func:clientSpisok}).inp(C.find),
$("#buttonCreate").click(clientAdd));$("#client-info").length&&($(".cedit").click(function(){function a(){var a={op:"client_edit",client_id:CLIENT.id,org:$.trim($("#ca-org").val()),fio:$.trim($("#ca-fio").val()),telefon:$.trim($("#ca-telefon").val()),adres:$.trim($("#ca-adres").val())};a.fio?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),c.close(),_msg("Данные клиента изменены")):(b(a.text),c.abort())},"json")):(b("Обязательно укажите название организации или контактное лицо"),
$("#ca-org").focus())}function b(a){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:-47,left:110,indent:70,show:1,remove:1})}var c=_dialog({head:"Редактирование данных клиента",top:30,width:450,content:'<table class="client-add e"><tr><td class="label">Название организации:<td><input type="text" id="ca-org" maxlength="100" value="'+CLIENT.org+'"><tr><td class="label">Контактное лицо:<td><input type="text" id="ca-fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="ca-telefon" maxlength="100" value="'+
CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="ca-adres" maxlength="100" value="'+CLIENT.adres+'"></table>',butSubmit:"Сохранить",submit:a});$("#ca-org,#ca-fio,#ca-telefon,#ca-adres").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),
_msg("Клиент удален!"),location.href=URL+"&p=client"):a.abort()},"json")}})}));$(".zayav-info").length&&$(".edit").click(function(){var a=_dialog({width:500,top:30,head:ZAYAV.head+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label topi">Изделие:<td id="product"></table>',butSubmit:"Сохранить",submit:function(){var b,c={op:"zakaz_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get")};c.product?"count_error"==
c.product?b="Некорректно введено количество изделий":(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):a.abort()},"json")):b="Не указаны изделия";b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}});$("#product").productList(ZAYAV.product)});$("#stock").length&&($(".vkButton").click(function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",left:130,top:-47,indent:50,
show:1,remove:1})}var b='<table id="stock-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="category_id" /><a href="'+URL+'&p=setup&d=stock" class="img_edit'+_tooltip("Настроить категорию комплектующих",-220,"r")+'</a><tr><td class="label">Наименование:<td><input type="text" id="name" /><tr><td class="label">Единица измерения:<td><input type="hidden" id="measure" /><tr><td class="label">Расход на м&sup2;:<td><input type="text" id="expense" /></table>',c=_dialog({top:70,width:450,
head:"Внесение новой позиции склада",content:b,submit:function(){var b={op:"stock_add",category_id:$("#category_id").val(),name:$.trim($("#name").val()),measure:1*$("#measure").val(),expense:$.trim($("#expense").val())};b.name?b.measure?b.expense&&!REGEXP_NUMERIC.test(b.expense)?a("Некорректно указан расход на м&sup2;"):(c.process(),$.post(AJAX_MAIN,b,function(a){c.abort();a.success&&(c.close(),stockSpisok())},"json")):a("Не указана единица измерения"):a("Не указано наименование")}});$("#category_id")._select({width:270,
title0:"Не выбрана",spisok:STOCK_SPISOK});$("#measure")._select({width:90,title0:"Не указана",spisok:MEASURE_SPISOK});$("#name").focus()}),$("#find")._search({width:250,focus:1,txt:"Быстрый поиск...",enter:1,func:stockSpisok}).inp(STOCK.find))});
